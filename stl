#!/bin/bash
# stl - stools å‘½ä»¤ä¸»å…¥å£è„šæœ¬
# ä½œè€…ï¼šfrogchou
# è¯´æ˜ï¼šç»Ÿä¸€ç®¡ç†å’Œè°ƒç”¨ tools ä¸‹çš„è„šæœ¬å·¥å…·ï¼Œæ”¯æŒæºç®¡ç†ã€æœç´¢ã€ç¦»çº¿ä¸‹è½½ç­‰

# ========== é…ç½® ==========
CONFIG_FILE="$HOME/.stoolsrc"
TOOLS_DIR="/opt/stools/tools"
META_FILE="/opt/stools/meta/tools.json"
DEFAULT_SOURCE="https://raw.githubusercontent.com/frogchou/stools/main"

# ========== åˆå§‹åŒ–é…ç½®æ–‡ä»¶ ==========
init_config() {
    if [ ! -f "$CONFIG_FILE" ]; then
        echo "SOURCE=$DEFAULT_SOURCE" > "$CONFIG_FILE"
    fi
    source "$CONFIG_FILE"
}

# ========== å·¥å…·å‡½æ•° ==========
print_help() {
    cat << EOF
stl - Linux å·¥å…·ç®±ç»Ÿä¸€å…¥å£

ç”¨æ³•ï¼š
  stl help                         æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯
  stl source <URL>                è®¾ç½®æ–°çš„å·¥å…·æº
  stl list                        åˆ—å‡ºæ‰€æœ‰å¯ç”¨å·¥å…·
  stl search <å…³é”®è¯>             æœç´¢å·¥å…·
  stl install-all                 ä¸‹è½½æ‰€æœ‰å·¥å…·åˆ°æœ¬åœ°
  stl update <å·¥å…·å>             æ›´æ–°æŒ‡å®šå·¥å…·
  stl update-all                  æ›´æ–°æ‰€æœ‰å·²å®‰è£…çš„å·¥å…·
  stl uninstall <å·¥å…·å>          å¸è½½æŒ‡å®šå·¥å…·
  stl <å·¥å…·å> [å‚æ•°]             æ‰§è¡ŒæŒ‡å®šå·¥å…·
EOF
}

set_source() {
    echo "SOURCE=$1" > "$CONFIG_FILE"
    echo "âœ… æºå·²è®¾ç½®ä¸ºï¼š$1"
}

fetch_meta() {
    mkdir -p "$(dirname "$META_FILE")"
    echo "â„¹ï¸ æ­£åœ¨ä» $SOURCE è·å–æœ€æ–°çš„å·¥å…·åˆ—è¡¨..."
    if curl -fsSL "$SOURCE/meta/tools.json" -o "$META_FILE.tmp"; then
        mv "$META_FILE.tmp" "$META_FILE"
        echo "âœ… å·¥å…·åˆ—è¡¨å·²æ›´æ–°ã€‚"
    else
        echo "âŒ ä»æºè·å–å·¥å…·åˆ—è¡¨å¤±è´¥ã€‚"
        if [ -f "$META_FILE" ]; then
            echo "âš ï¸ å°†ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„å·¥å…·åˆ—è¡¨ã€‚"
        else
            echo "âŒ æœ¬åœ°ä¹Ÿæ— ç¼“å­˜çš„å·¥å…·åˆ—è¡¨ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ–æºåœ°å€ ($SOURCE)ã€‚"
            return 1 # è¿”å›é”™è¯¯ç ï¼Œä»¥ä¾¿è°ƒç”¨è€…å¤„ç†
        fi
    fi
    return 0
}

list_tools() {
    if ! fetch_meta; then
        return 1
    fi
    if [ -f "$META_FILE" ]; then
        if jq -r '.[] | "- " + .name + "ï¼š" + .description' "$META_FILE"; then
            return 0
        else
            echo "âŒ è§£æå·¥å…·åˆ—è¡¨å¤±è´¥ã€‚å…ƒæ•°æ®æ–‡ä»¶ ($META_FILE) å¯èƒ½å·²æŸåã€‚"
            return 1
        fi
    else
        # fetch_meta åº”è¯¥å·²ç»å¤„ç†äº†è¿™ç§æƒ…å†µï¼Œä½†ä½œä¸ºåŒé‡æ£€æŸ¥
        echo "âŒ æ— æ³•è·å–å·¥å…·åˆ—è¡¨ï¼Œå…ƒæ•°æ®æ–‡ä»¶ä¸å­˜åœ¨ã€‚"
        return 1
    fi
}

search_tool() {
    if ! fetch_meta; then
        return 1
    fi
    local keyword=$1
    if [ -f "$META_FILE" ]; then
        # ä½¿ç”¨ --arg å°† shell å˜é‡å®‰å…¨ä¼ é€’ç»™ jq
        # å°† jq è„šæœ¬ä¸»ä½“æ”¾åœ¨å•å¼•å·ä¸­ï¼Œä»¥é¿å… shell æ‰©å±•é—®é¢˜
        # ä¿®æ­£äº† tags çš„æ£€æŸ¥ï¼Œç¡®ä¿åœ¨ tags ä¸å­˜åœ¨æˆ–ä¸ä¸ºæ•°ç»„æ—¶ä¸ä¼šæŠ¥é”™
        local jq_script='.[] | select(
            (.name | test($kw; "i")) or
            (.description | test($kw; "i")) or
            ([.tags[]? | strings] | any(test($kw; "i"))) # ç¡®ä¿ tags æ˜¯å­—ç¬¦ä¸²æ•°ç»„ä¸”è¿›è¡Œå®‰å…¨è¿­ä»£
        ) | "- " + .name + "ï¼š" + .description'

        if ! jq --arg kw "$keyword" -r "$jq_script" "$META_FILE"; then
            echo "âŒ æœç´¢å·¥å…·å¤±è´¥ã€‚å…ƒæ•°æ®æ–‡ä»¶ ($META_FILE) å¯èƒ½å·²æŸåã€å…³é”®è¯æ ¼å¼é”™è¯¯æˆ– jq æ‰§è¡Œå‡ºé”™ã€‚"
            return 1
        fi
    else
        echo "âŒ æ— æ³•æœç´¢å·¥å…·ï¼Œå…ƒæ•°æ®æ–‡ä»¶ä¸å­˜åœ¨ã€‚"
        return 1
    fi
}

download_all() {
    if ! fetch_meta; then
        return 1
    fi
    mkdir -p "$TOOLS_DIR"
    if [ ! -f "$META_FILE" ]; then
        echo "âŒ æ— æ³•ä¸‹è½½å·¥å…·ï¼Œå…ƒæ•°æ®æ–‡ä»¶ä¸å­˜åœ¨ã€‚"
        return 1
    fi

    echo "â„¹ï¸ å¼€å§‹ä¸‹è½½æ‰€æœ‰å·¥å…·..."
    local all_successful=true
    jq -r '.[] | .file' "$META_FILE" | while IFS= read -r tool_file; do
        local tool_name="${tool_file%.sh}" # ä»æ–‡ä»¶åä¸­æå–å·¥å…·åï¼Œä¾‹å¦‚ lan_ping_scan.sh -> lan_ping_scan
        echo "ğŸ”„ æ­£åœ¨ä¸‹è½½å·¥å…· $tool_name ($tool_file)..."
        if curl -fsSL "$SOURCE/tools/$tool_file" -o "$TOOLS_DIR/$tool_file"; then
            chmod +x "$TOOLS_DIR/$tool_file"
            echo "âœ… å·¥å…· $tool_name ä¸‹è½½æˆåŠŸã€‚"
        else
            echo "âŒ ä¸‹è½½å·¥å…· $tool_name ($tool_file) å¤±è´¥ã€‚"
            all_successful=false
        fi
    done

    if [ "$all_successful" = true ]; then
        echo "âœ… æ‰€æœ‰å·¥å…·å·²æˆåŠŸä¸‹è½½è‡³ $TOOLS_DIR"
    else
        echo "âš ï¸ éƒ¨åˆ†å·¥å…·ä¸‹è½½å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ–æºåœ°å€ã€‚"
        return 1
    fi
    return 0
}

update_tool() {
    local tool_name=$1
    local tool_filename="$tool_name.sh"
    local tool_path="$TOOLS_DIR/$tool_filename"

    echo "ğŸ”„ æ­£åœ¨æ›´æ–°å·¥å…· $tool_name..."

    # æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
    local source_host
    source_host=$(echo "$SOURCE" | sed -E 's_https?://([^/]+)/?.*_\1_')
    if ! command -v ping &> /dev/null; then
        echo "âš ï¸ ping å‘½ä»¤æœªæ‰¾åˆ°ï¼Œè·³è¿‡ç½‘ç»œè¿é€šæ€§æ£€æŸ¥ã€‚"
    elif ! ping -c 1 "$source_host" &> /dev/null; then
        echo "âŒ ç½‘ç»œè¿æ¥åˆ° $source_host å¤±è´¥ã€‚æ— æ³•æ›´æ–°å·¥å…·ã€‚"
        return 1
    fi

    mkdir -p "$TOOLS_DIR"
    if curl -fsSL "$SOURCE/tools/$tool_filename" -o "$tool_path"; then
        chmod +x "$tool_path"
        echo "âœ… å·¥å…· $tool_name æ›´æ–°æˆåŠŸã€‚"
        return 0
    else
        echo "âŒ æ›´æ–°å·¥å…· $tool_name ($tool_filename) å¤±è´¥ã€‚"
        # ä¸åˆ é™¤æ—§æ–‡ä»¶ï¼Œä»¥ä¾¿ç”¨æˆ·åœ¨æ›´æ–°å¤±è´¥æ—¶ä»å¯ä½¿ç”¨æ—§ç‰ˆæœ¬
        return 1
    fi
}

update_all_tools() {
    if ! fetch_meta; then
        return 1
    fi
    mkdir -p "$TOOLS_DIR"
    if [ ! -f "$META_FILE" ]; then
        echo "âŒ æ— æ³•æ›´æ–°å·¥å…·ï¼Œå…ƒæ•°æ®æ–‡ä»¶ä¸å­˜åœ¨ã€‚"
        return 1
    fi

    echo "â„¹ï¸ å¼€å§‹æ›´æ–°æ‰€æœ‰å·¥å…·..."
    local all_successful=true
    jq -r '.[] | .file' "$META_FILE" | while IFS= read -r tool_file; do
        local tool_name="${tool_file%.sh}"
        # åªæ›´æ–°å®é™…å­˜åœ¨äºæœ¬åœ°çš„å·¥å…·ï¼Œæˆ–è€…å…¨éƒ¨é‡æ–°ä¸‹è½½ï¼ˆå–å†³äºç­–ç•¥ï¼Œæ­¤å¤„é€‰æ‹©å…¨éƒ¨å°è¯•æ›´æ–°ï¼‰
        echo "ğŸ”„ æ­£åœ¨æ›´æ–°å·¥å…· $tool_name ($tool_file)..."
        if curl -fsSL "$SOURCE/tools/$tool_file" -o "$TOOLS_DIR/$tool_file"; then
            chmod +x "$TOOLS_DIR/$tool_file"
            echo "âœ… å·¥å…· $tool_name æ›´æ–°æˆåŠŸã€‚"
        else
            echo "âŒ æ›´æ–°å·¥å…· $tool_name ($tool_file) å¤±è´¥ã€‚"
            all_successful=false
        fi
    done

    if [ "$all_successful" = true ]; then
        echo "âœ… æ‰€æœ‰å·¥å…·å·²æˆåŠŸæ›´æ–°ã€‚"
    else
        echo "âš ï¸ éƒ¨åˆ†å·¥å…·æ›´æ–°å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ–æºåœ°å€ã€‚"
        return 1
    fi
    return 0
}

uninstall_tool() {
    local tool_name=$1
    local tool_filename="$tool_name.sh"
    local tool_path="$TOOLS_DIR/$tool_filename"

    if [ ! -f "$tool_path" ]; then
        echo "â„¹ï¸ å·¥å…· $tool_name æœªå®‰è£…ï¼Œæ— éœ€å¸è½½ã€‚"
        return 0
    fi

    echo "â“ æ˜¯å¦ç¡®å®šå¸è½½å·¥å…· $tool_name ($tool_path)ï¼Ÿ (y/N)"
    read -r confirmation
    if [[ "$confirmation" =~ ^[Yy]$ ]]; then
        if rm -f "$tool_path"; then
            echo "âœ… å·¥å…· $tool_name å·²æˆåŠŸå¸è½½ã€‚"
            return 0
        else
            echo "âŒ å¸è½½å·¥å…· $tool_name å¤±è´¥ã€‚è¯·æ£€æŸ¥æƒé™ã€‚"
            return 1
        fi
    else
        echo "â„¹ï¸ å·²å–æ¶ˆå¸è½½æ“ä½œã€‚"
        return 0
    fi
}

run_tool() {
    local tool_name=$1
    shift
    local tool_filename="$tool_name.sh" # å‡è®¾å·¥å…·æ–‡ä»¶åæ€»æ˜¯ .sh ç»“å°¾
    local tool_path="$TOOLS_DIR/$tool_filename"

    # æ£€æŸ¥å·¥å…·æ˜¯å¦å·²åœ¨æœ¬åœ°
    if [ -f "$tool_path" ]; then
        echo "â„¹ï¸ ä»æœ¬åœ°æ‰§è¡Œå·¥å…· $tool_name..."
        "$tool_path" "$@"
        return $? # è¿”å›å·¥å…·è„šæœ¬çš„é€€å‡ºçŠ¶æ€
    fi

    # å¦‚æœæœ¬åœ°æ²¡æœ‰ï¼Œå°è¯•ä¸‹è½½
    echo "â„¹ï¸ å·¥å…· $tool_name æœªåœ¨æœ¬åœ°æ‰¾åˆ°ã€‚"
    echo "ğŸ”„ æ­£åœ¨å°è¯•ä» $SOURCE ä¸‹è½½å·¥å…· $tool_name..."

    # ç®€å•æ£€æŸ¥ç½‘ç»œè¿é€šæ€§ (ping æºä¸»æœº)
    # æå–ä¸»æœºåç”¨äº ping
    local source_host
    source_host=$(echo "$SOURCE" | sed -E 's_https?://([^/]+)/?.*_\1_')

    # æ£€æŸ¥ ping å‘½ä»¤æ˜¯å¦å­˜åœ¨
    if ! command -v ping &> /dev/null; then
        echo "âš ï¸ ping å‘½ä»¤æœªæ‰¾åˆ°ï¼Œè·³è¿‡ç½‘ç»œè¿é€šæ€§æ£€æŸ¥ã€‚"
    elif ! ping -c 1 "$source_host" &> /dev/null; then
        echo "âŒ ç½‘ç»œè¿æ¥åˆ° $source_host å¤±è´¥ã€‚æ— æ³•ä¸‹è½½æ–°å·¥å…·ã€‚"
        echo "âŒ å·¥å…· $tool_name ä¸å­˜åœ¨ä¸”æ— æ³•ä¸‹è½½ã€‚"
        return 1
    fi
    
    mkdir -p "$TOOLS_DIR" # ç¡®ä¿å·¥å…·ç›®å½•å­˜åœ¨
    if curl -fsSL "$SOURCE/tools/$tool_filename" -o "$tool_path"; then
        chmod +x "$tool_path"
        echo "âœ… å·¥å…· $tool_name ä¸‹è½½æˆåŠŸã€‚"
        echo "â„¹ï¸ æ­£åœ¨æ‰§è¡Œå·¥å…· $tool_name..."
        "$tool_path" "$@"
        return $?
    else
        echo "âŒ ä¸‹è½½å·¥å…· $tool_name ($tool_filename) å¤±è´¥ã€‚"
        # æ¸…ç†å¯èƒ½ä¸‹è½½ä¸å®Œæ•´çš„æ–‡ä»¶
        if [ -f "$tool_path" ]; then
            rm "$tool_path"
        fi
        echo "âŒ å·¥å…· $tool_name ä¸å­˜åœ¨ä¸”æ— æ³•ä¸‹è½½ã€‚"
        return 1
    fi
}

# ========== ä¸»é€»è¾‘ ==========
init_config

case "$1" in
    help|-h|--help)
        print_help
        ;;
    source)
        if [ -z "$2" ]; then echo "â— ç¼ºå°‘æºåœ°å€"; exit 1; fi
        set_source "$2"
        ;;
    list)
        list_tools
        ;;
    search)
        if [ -z "$2" ]; then echo "â— ç¼ºå°‘å…³é”®è¯"; exit 1; fi
        search_tool "$2"
        ;;
    install-all)
        download_all
        ;;
    update)
        if [ -z "$2" ]; then
            echo "â— è¯·æŒ‡å®šè¦æ›´æ–°çš„å·¥å…·åç§°ï¼Œæˆ–ä½¿ç”¨ 'update-all' æ›´æ–°æ‰€æœ‰å·¥å…·ã€‚"
            exit 1
        fi
        if [ "$2" == "all" ]; then # å…¼å®¹ update all çš„å†™æ³•
            echo "â„¹ï¸ 'update all' å·²è¢«è¯†åˆ«ä¸º 'update-all'ã€‚æ­£åœ¨æ›´æ–°æ‰€æœ‰å·¥å…·..."
            update_all_tools
        else
            update_tool "$2"
        fi
        ;;
    update-all)
        update_all_tools
        ;;
    uninstall)
        if [ -z "$2" ]; then
            echo "â— è¯·æŒ‡å®šè¦å¸è½½çš„å·¥å…·åç§°ã€‚"
            exit 1
        fi
        uninstall_tool "$2"
        ;;
    "")
        print_help
        ;;
    *)
        run_tool "$@"
        ;;
esac
